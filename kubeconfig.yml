---
- name: Install k3s server (master)
  hosts: k3s_master
  become: yes
  vars:
    k3s_version: ""   # z.B. "v1.30.3+k3s1" oder leer fÃ¼r "latest"
    k3s_tls_san: "192.168.10.113"  # IP oder DNS-Name, mit dem du den API-Server ansprechen willst
  tasks:
    - name: Disable swap (runtime)
      command: swapoff -a
      when: ansible_swaptotal_mb | default(0) > 0
      ignore_errors: yes

    - name: Disable swap in fstab (permanent)
      replace:
        path: /etc/fstab
        regexp: '(^.*swap.*$)'
        replace: '# \1'
      ignore_errors: yes

    - name: Install k3s server
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" INSTALL_K3S_EXEC="server --cluster-init --tls-san {{ k3s_tls_san }}" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Read k3s node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token_raw

    - name: Set k3s_node_token fact
      set_fact:
        k3s_node_token: "{{ node_token_raw.content | b64decode | trim }}"

    - name: Copy kubeconfig to control machine
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ./kubeconfig/k3s.yaml
        flat: yes

- name: Install k3s agents (worker nodes)
  hosts: k3s_nodes
  become: yes
  vars:
    k3s_master_ip: "192.168.10.113"
  tasks:
    - name: Disable swap (runtime)
      command: swapoff -a
      when: ansible_swaptotal_mb | default(0) > 0
      ignore_errors: yes

    - name: Disable swap in fstab (permanent)
      replace:
        path: /etc/fstab
        regexp: '(^.*swap.*$)'
        replace: '# \1'
      ignore_errors: yes

    - name: Install k3s agent
      shell: |
        curl -sfL https://get.k3s.io | \
        K3S_URL="https://{{ k3s_master_ip }}:6443" \
        K3S_TOKEN="{{ hostvars[groups['k3s_master'][0]].k3s_node_token }}" \
        sh -
      args:
        creates: /usr/local/bin/k3s
